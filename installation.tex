\section{Installation}

\subsection{Installation du système}

La première étape de notre projet consistait en l’installation de serveurs de téléphonie SIP. Nous en avons installé deux, fontionnant avec le système d’exploitation Debian. Nous avons choisi d’installer la dernière version stable disponible au moment de l’installation, la 7.7.0 (\textit{Wheezy}) en version \textit{i386}, à partir de l’installeur \textit{netinstall}, c’est-à-dire celui qui profite du réseau pour télécharger les paquets qui ne sont pas indispensables, afin de réduire la quantité d’information à graver sur le CD-ROM.

Conformément à notre cahier des charges, nous y avons installé un proxy SIP, {\kam}, attaché à un serveur d’authentification {\rad}, {\frad}.

\subsection{\kam}

\subsubsection{Installation}

Pour installer {\kam}, il nous a fallu commencer par installer les dépendances qui n’étaient pas encore présentes dans le système, disponibles dans les paquets :

\begin{itemize}
	\item{gcc} ;
	\item{bison} ;
	\item{libmysqlclient-dev} ;
	\item{libradiusclient-ng-dev} ;
	\item{mysql-server} ;
	\item{mysql-client} ;
	\item{make}.
\end{itemize}

Nous avions initialement envisagé d’utiliser ensuite les paquets Debian disponibles sur les serveurs de {\kam}, mais le paquet de base n’est pas compilé avec le support de {\rad}, rendant le paquet des bibliothèques d’authentification {\rad} inopérant.

Nous avons donc téléchargé et décompressé les sources de {\kam} pour les compiler. Nous avons choisi d’utiliser la dernière version disponible, qui était la version 4.2.2. Pour cela, nous avons utilisé les commandes :

\begin{shellcode}
wget http://www.kamailio.org/pub/kamailio/4.2.2/src/kamailio-4.2.2_src.tar.gz
tar xvf kamailio-4.2.2_src.tar.gz
\end{shellcode}

Puis nous sommes allés dans le dossier ainsi créé, \texttt{kamailio-4.2.2}, et nous avons exécuté :

\begin{shellcode}
make cfg
\end{shellcode}

Cette commande construit la configuration par défaut pour la compilation, qu’il a fallu adapter à nos besoins. Conformément aux indications du rapport de l’année dernière, nous avons effectué les modifications suivantes :

\begin{itemize}
	\item{dans la liste de modules exclus du fichier \texttt{module.lst}, nous avons retiré les noms des modules concernant {\my} et {\rad}} ;
	\item{dans le fichier \texttt{modules\_k/acc}, nous avons décommenté la ligne \texttt{ENABLE\_RADIUS\_ACC=true}}.
\end{itemize}

Nous avons ensuite compilé et installé {\kam} :

\begin{shellcode}
make all
make install
\end{shellcode}

Cette dernière commande installe {\kam} dans \texttt{/usr/local}.

\subsubsection{Configuration}

Nous avons dû ensuite configurer {\kam}. Nous sommes allés dans le dossier \texttt{/usr/local/etc/kamailio}. Il a fallu rajouter les lignes suivantes dans le fichier de configuration \texttt{kamailio.cfg} :

\begin{kamcf}
#!define WITH_MYSQL
#!define WITH_AUTH
#!define WITH_USRLOCDB
#!define WITH_NAT
\end{kamcf}

Nous avons alors créé puis configuré la base de données. Pour la créer, il a fallu d'abord préciser quel système de base de données nous allions utiliser.
Dans notre cas, c'est mysql. C'est pourquoi il a fallu aller dans le fichier \texttt{/usr/local/etc/kamailio/kamctlrc} afin de décommenter la ligne :

\begin{kamcf}
DBENGINE=MYSQL
\end{kamcf}

Ensuite, nous avons tapé 
\begin{shellcode}
/usr/local/sbin/kamdbctl create
\end{shellcode}
\todo

\subsection{\frad}
\subsubsection{Installation}

Nous avons installé {\frad} ainsi que les outils de test associés à partir des paquets disponibles. Pour cela, il a fallu taper la commande :

\begin{shellcode}
apt-get install freeradius freeradius-utils
\end{shellcode}

Puis, pour finir, nous avons installé le client {\rad} proposé par {\frad} grâce à la commande suivante :

\begin{shellcode}
apt-get install radiusclient1
\end{shellcode}

\subsubsection{Configuration}
Nous avions fini d'installer {\frad}. Il nous restait donc à le configurer. Ce serveur {\rad} peut être configuré de deux manières différentes : soit à partir des fichiers présents dans \texttt{/etc/freeradius}, soit à partir d'une base de données. Nous avons choisi de configurer à partir des fichiers. Il a donc fallu aller vérifier si la configuration se faisait bien grâce aux fichiers. Pour cela, il a suffi d'aller vérifier dans le fichier \texttt{/etc/freeradius/sites-available/default}.

Ensuite, nous sommes allés dans le répertoire \texttt{/etc/freeradius} afin de modifier le fichier \texttt{users}. Dans ce fichier, nous avons ajouté des utilisateurs de la façon suivantes :

login Cleartext-Password:="password"

Cette ligne autorise l'utilisateur login à se connecter avec le mot de passe "password".

Nous avons pû ensuite faire le test en utilisant la commande suivante :

\begin{shellcode}
radtest login password localhost 0 testing123
\end{shellcode}

Le paramètre "testing123" est le mot de passe donné par défaut au client localhost dans le fichier \texttt{/etc/freeradius/client.conf}. Nous l'avons ensuite changé en "kamailio".

\subsubsection{Intégration de {\rad} à {\kam}}

Pour commencer, il a fallu copier les dictionnaires \texttt{dictionary.kamailio} et \texttt{dictionary.sip} dans le répertoire \texttt{/etc/radiusclient-ng} :

\begin{shellcode}
cp /usr/local/etc/kamailio/dictionary.kamailio /etc/radiusclient-ng
cp /usr/local/etc/kamailio/dictionary.sip /etc/radiusclient-ng
\end{shellcode}

Puis, nous avons inclus dans \texttt{/etc/radiusclient-ng/dictionary} les deux fichiers suivants :

\begin{itemize}
\item{\texttt{/etc/radiusclient-ng/dictionary.kamailio} ;}
\item{\texttt{/etc/radiusclient-ng/dictionary.sip}.}
\end{itemize}

Puis il a fallu décommenter les lignes des attributs ou des valeurs Failed, Sip-Session et Call-Check dans les trois fichiers dictionary.

Nous avons ensuite dû vérifier que les deux lignes suivantes,qui donnent l'adresse du serveur {\rad}, se trouvaient bien dans le fichier \texttt{/etc/radiusclient-ng/radiusclient.conf} :

\begin{verbatim}
authserver localhost
acctserver localhost
\end{verbatim}

